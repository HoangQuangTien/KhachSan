<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Khuyến Mãi</title>

    <!--    <link rel="stylesheet" th:href="@{/css/homeKM.css}">-->
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">



    <style>
        /* Tăng kích thước modal Sửa Khuyến Mãi */
        .editModal .modal-lg {
            max-width: 60%;
        }

        /* Định dạng khoảng cách trong modal Sửa Khuyến Mãi */
        .editModal .modal-body {
            padding: 1.5rem;
        }

        /* Định dạng cho các trường đầu vào và nhãn trong modal Sửa Khuyến Mãi */
        .editModal .form-label,
        .editModal .form-control,
        .editModal .form-select {
            font-size: 1rem;
        }

        /* Định dạng cho textarea để không thể thay đổi kích thước trong modal Sửa Khuyến Mãi */
        .editModal textarea.form-control {
            resize: none;
        }
    </style>

    <style>
        /* Tăng kích thước modal Thêm Khuyến Mãi */
        .addModal .modal-lg {
            max-width: 50%;
        }

        /* Định dạng khoảng cách trong modal Thêm Khuyến Mãi */
        .addModal .modal-body {
            padding: 2rem; /* Tăng khoảng cách để tránh chèn chúc */
        }

        /* Định dạng cho các trường đầu vào và nhãn trong modal Thêm Khuyến Mãi */
        .addModal .form-label {
            font-weight: bold; /* Làm nổi bật nhãn */
            margin-bottom: 0.5rem; /* Khoảng cách giữa nhãn và trường nhập */
        }

        .addModal .form-control,
        .addModal .form-select {
            font-size: 1rem; /* Kích thước chữ */
            margin-bottom: 1rem; /* Khoảng cách giữa các trường */
        }

        /* Định dạng cho textarea để không thể thay đổi kích thước trong modal Thêm Khuyến Mãi */
        .addModal textarea.form-control {
            resize: none; /* Không cho phép thay đổi kích thước textarea */
            height: 100px; /* Đặt chiều cao cố định cho textarea */
        }

        /* Định dạng cho các nút trong modal */
        .addModal .btn-warning-custom {
            background-color: #ff9800; /* Màu nền nút */
            color: #fff; /* Màu chữ nút */
            border: none; /* Bỏ viền nút */
            padding: 0.5rem 1.5rem; /* Kích thước padding */
            font-size: 1rem; /* Kích thước chữ */
            margin-top: 1rem; /* Khoảng cách phía trên nút */
        }

        .addModal .btn-warning-custom:hover {
            background-color: #e68900; /* Màu nền khi hover */
        }

        /* Định dạng cho thông báo lỗi */
        .addModal .alert-danger {
            font-size: 0.875rem; /* Kích thước chữ thông báo lỗi */
            margin-bottom: 1rem; /* Khoảng cách dưới thông báo lỗi */
        }

        .table-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .table-container h3 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #f4f4f9;
        }

        table tr:hover {
            background-color: #f9f9f9;
        }


        .filter-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination a,
        .pagination .current-page {
            padding: 8px 15px;
            margin: 0 5px;
            text-decoration: none;
            color: #007bff;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .pagination a:hover {
            background-color: #007bff;
            color: #fff;
        }

        .pagination .current-page {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        .pagination .prev,
        .pagination .next {
            font-weight: bold;
        }

        .pagination .prev:hover,
        .pagination .next:hover {
            background-color: #28a745;
            color: white;
        }

        .pagination .prev,
        .pagination .next {
            padding: 8px 12px;
            font-size: 18px;
        }

        .pagination a:disabled {
            color: #aaa;
            pointer-events: none;
            cursor: not-allowed;
        }

    </style>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <head th:include="fragment/head :: head"></head>
</head>
<body class="vertical light">

<div th:include="fragment/navbar :: navbar"></div>
<div th:include="fragment/sidebar :: sidebar"></div>
<main class="main-content" role="main">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12">
                <h2 class="mb-2 page-title">Quản lý khuyến mãi</h2>
                <p class="card-text"></p>
                <div class="d-flex align-items-center mb-3 p-2 border rounded bg-light">
                    <!-- Ô tìm kiếm với icon -->
                    <div class="input-group me-3" style="width: 550px;">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" placeholder="Tìm kiếm"
                               onkeyup="searchKhuyenMai()" class="form-control border-start-0" />
                    </div>

                    <!-- Dropdown trạng thái với icon -->
                    <div class="input-group" style="width: 350px;">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-filter"></i></span>
                        <select id="trangThai" name="trangThai" class="form-control border-start-0" onchange="searchKhuyenMai()">
                            <option value="">Tất cả</option>
                            <option value="Còn hạn" th:selected="${param.trangThai eq 'Còn hạn'}">Còn hạn</option>
                            <option value="Sắp diễn ra" th:selected="${param.trangThai eq 'Sắp diễn ra'}">Sắp diễn ra</option>
                            <option value="Hết hạn" th:selected="${param.trangThai eq 'Hết hạn'}">Hết hạn</option>
                        </select>
                    </div>
                </div>





                <!-- Nút mở modal thêm Khuyến Mãi -->
                <div class="mb-3 d-flex justify-content-end">
                    <a type="button" class="btn btn-success me-1" data-bs-toggle="modal" data-bs-target="#addKhuyenMaiModal">
                        <i class="fas fa-plus" style="color: #fcfcfc; top: 20px"></i>
                    </a>

                    <a data-bs-toggle="modal" data-bs-target="#add" class="btn btn-success">
                        <i class="fa-regular fa-paper-plane" style="color: #fcfcfc; top: 20px"></i>
                    </a>
                </div>

                <div class="table-container">
                    <h3><i class="fa-solid fa-list" style="color: #000000;"></i> Danh sách giảm giá</h3>

                    <!-- Bảng danh sách khuyến mãi -->
                    <table class="table table-striped table-bordered" id="resultsContainer">
                        <thead class="table-light">
                        <tr>
                            <th>Mã Khuyến Mãi</th>
                            <th>Tên Khuyến Mãi</th>
                            <th>Giảm Giá</th>
                            <th>Loại Giảm</th>
                            <th>Số Lượng</th>
                            <th>Giảm Tối Thiểu</th>
                            <th>Giảm Tối Đa</th>
                            <th>Trạng Thái</th>
                            <th>Hành Động</th>
                        </tr>
                        </thead>
                        <tbody id="khuyenMaiTableBody">
                        <tr th:each="khuyenMai : ${khuyenMaiPage.content}">
                            <td th:text="${khuyenMai.maKhuyenMai}">Mã KM</td>
                            <td th:text="${khuyenMai.tenKhuyenMai}">Tên KM</td>
                            <td th:text="${#numbers.formatDecimal(khuyenMai.giamGia, 0, 0)}">Giảm Giá</td>
                            <td th:text="${khuyenMai.loaiGiam ? 'Phần Trăm' : 'Tiền Mặt'}">Loại Giảm</td>
                            <td th:text="${khuyenMai.soLuong}">Số Lượng</td>
                            <td class="format-number" th:text="${khuyenMai.giamToiThieu}">Giảm Tối Thiểu</td>
                            <td class="format-number" th:text="${khuyenMai.giamToiDa}">Giảm Tối Đa</td>
                            <td th:text="${khuyenMai.trangThai}">Trạng Thái</td>
                            <td>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editKhuyenMaiModal"
                                        th:data-idKhuyenMai="${khuyenMai.idKhuyenMai}"
                                        th:data-maKhuyenMai="${khuyenMai.maKhuyenMai}"
                                        th:data-tenKhuyenMai="${khuyenMai.tenKhuyenMai}"
                                        th:data-moTa="${khuyenMai.moTa}"
                                        th:data-giamGia="${#numbers.formatDecimal(khuyenMai.giamGia, 0, 0)}"
                                        th:data-soLuong="${khuyenMai.soLuong}"
                                        th:data-giamToiThieu="${#numbers.formatDecimal(khuyenMai.giamToiThieu, 0, 0)}"
                                        th:data-giamToiDa="${#numbers.formatDecimal(khuyenMai.giamToiDa, 0, 0)}"
                                        th:data-ngayBatDau="${#dates.format(khuyenMai.ngayBatDau,'yyyy-MM-dd')}"
                                        th:data-ngayKetThuc="${#dates.format(khuyenMai.ngayKetThuc,'yyyy-MM-dd')}"
                                        th:data-loaiGiam="${khuyenMai.loaiGiam ? 'true' : 'false'}"
                                        th:data-trangThai="${khuyenMai.trangThai == 'conHan' ? 'conHan' :
                                    (khuyenMai.trangThai == 'hetHan' ? 'hetHan' : 'sapDienRa')}"

                                        onclick="setModalData(this)">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <br>
                                <form th:action="@{/admin/quan-ly-khuyen-mai/delete/{id}(id=${khuyenMai.idKhuyenMai})}"
                                      method="post" style="display:inline;">
                                </form>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>



                <!-- Modal thêm khuyến mãi -->
                <div class="modal fade" id="addKhuyenMaiModal" tabindex="-1" aria-labelledby="addKhuyenMaiModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addKhuyenMaiModalLabel">Thêm Khuyến Mãi</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <div class="modal-body">
                                <div id="error-message" class="alert alert-danger d-none"></div>
                                <!-- Form thêm khuyến mãi -->
                                <form th:action="@{/admin/quan-ly-khuyen-mai/add}" method="POST" id="form-add-promotion">

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="maKhuyenMai">Mã Khuyến Mãi:</label>
                                            <div class="input-group">
                                                <input type="text" id="maKhuyenMai" name="maKhuyenMai"
                                                       class="form-control" placeholder="Mã khuyến mãi"/>
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="generateMaKhuyenMai()">
                                                        <i class="fas fa-sync-alt"></i> Tạo mã
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="tenKhuyenMai">Tên Khuyến Mãi:</label>
                                            <input type="text" id="tenKhuyenMai" name="tenKhuyenMai" class="form-control" placeholder="Tên khuyến mãi"/>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-12">
                                            <label for="moTa">Mô Tả:</label>
                                            <input type="text" id="moTa" name="moTa" class="form-control" placeholder="Mô tả"/>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="soLuong">Số lượng:</label>
                                            <input type="number" id="soLuong" name="soLuong" class="form-control" placeholder="Số lượng"/>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="giamGia">Giảm Giá:</label>
                                            <input type="number" step="0.01" id="giamGia" name="giamGia" class="form-control" placeholder="Giảm giá"/>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="ngayBatDau">Ngày Bắt Đầu:</label>
                                            <input type="datetime-local" id="ngayBatDau" name="ngayBatDau" class="form-control" placeholder="Ngày bắt đầu"/>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="ngayKetThuc">Ngày Kết Thúc:</label>
                                            <input type="datetime-local" id="ngayKetThuc" name="ngayKetThuc" class="form-control" placeholder="Ngày kết thúc"/>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="loaiGiam">Loại Giảm:</label>
                                            <select id="loaiGiam" name="loaiGiam" class="form-control">
                                                <option value="true">Phần trăm</option>
                                                <option value="false">Tiền mặt</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="giamToiThieu">Giảm tối thiểu:</label>
                                            <input type="number" id="giamToiThieu" name="giamToiThieu" class="form-control"/>
                                        </div>

                                        <div class="form-group col-md-6">
                                            <label for="giamToiDa">Giảm tối đa:</label>
                                            <input type="number" id="giamToiDa" name="giamToiDa" class="form-control"/>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-warning-custom">Lưu</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable  modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">
                                    <i class="fa-solid fa-list" style="color: #000000;"></i>
                                    Danh sách khách hàng
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <button id="selectAllBtn" class="btn btn-primary" onclick="toggleSelectAll()">Chọn tất cả</button>
                                <div class="search-container">
                                    <input type="text" id="modalSearchInput" placeholder="Tìm kiếm khách hàng..." class="search-box">
                                    <button class="btn btn-primary" onclick="searchInModal()"><i class="fa-solid fa-magnifying-glass"></i> Tìm kiếm</button>
                                </div>
                                <div class="form-group">
                                    <label for="voucherId">Chọn Voucher</label>
                                    <select class="form-control" id="voucherId" name="voucherId">
                                        <option value="" disabled selected>-- Chọn Voucher --</option>
                                        <option th:each="voucher : ${activeVouchers}"
                                                th:value="${voucher.idKhuyenMai}"
                                                th:text="${voucher.maKhuyenMai} + ' - ' + ${voucher.tenKhuyenMai}"></option>
                                    </select>
                                </div>

                                <table>
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tên khách hàng</th>
                                        <th>Email</th>
                                        <!--                                                <th>Trạng thái</th>-->
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="kh,i: ${listKH}">
                                        <td>
                                            <input class="form-check-input" type="checkbox" value="" id="checkbox${i.count}">
                                        </td>
                                        <td th:text="${kh.hoVaTen }"></td>
                                        <td th:text="${kh.email}"></td>

                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-primary" id="sendEmailBtn">Gửi</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal sửa khuyến mãi -->
                <div class="modal fade editModal" id="editKhuyenMaiModal" tabindex="-1" aria-labelledby="editKhuyenMaiModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg"> <!-- Chỉnh modal lớn hơn -->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editKhuyenMaiModalLabel">Sửa Khuyến Mãi</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Form cập nhật khuyến mãi -->
                                <form id="editKhuyenMaiForm" onsubmit="return updateKhuyenMai()">
                                    <input type="hidden" id="editId" name="id" />
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="editMaKhuyenMai" class="form-label">Mã Khuyến Mãi</label>
                                            <input type="text" class="form-control" id="editMaKhuyenMai" name="maKhuyenMai" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editTenKhuyenMai" class="form-label">Tên Khuyến Mãi</label>
                                            <input type="text" class="form-control" id="editTenKhuyenMai" name="tenKhuyenMai" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editMoTa" class="form-label">Mô Tả</label>
                                            <textarea class="form-control" id="editMoTa" name="moTa" required></textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="editSoLuong" class="form-label">Số Lượng</label>
                                            <input type="number" class="form-control" id="editSoLuong" name="soLuong" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editGiamGia" class="form-label">Giảm Giá</label>
                                            <input type="number" class="form-control" id="editGiamGia" name="giamGia" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editGiamToiThieu" class="form-label">Giảm Tối Thiểu</label>
                                            <input type="number" class="form-control" id="editGiamToiThieu" name="giamToiThieu" required />
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="editGiamToiDa" class="form-label">Giảm Tối Đa</label>
                                            <input type="number" class="form-control" id="editGiamToiDa" name="giamToiDa" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editNgayBatDau" class="form-label">Ngày Bắt Đầu</label>
                                            <input type="datetime-local" class="form-control" id="editNgayBatDau" name="ngayBatDau" required />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="editNgayKetThuc" class="form-label">Ngày Kết Thúc</label>
                                            <input type="datetime-local" class="form-control" id="editNgayKetThuc" name="ngayKetThuc" required />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="editLoaiGiam" class="form-label">Loại Giảm</label>
                                            <select class="form-select" id="editLoaiGiam" name="loaiGiam" required>
                                                <option value="true">Phần Trăm</option>
                                                <option value="false">Tiền Mặt</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Cập Nhật</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phân trang -->

                <div class="pagination">
                    <a class="prev" th:if="${khuyenMaiPage.hasPrevious()}"
                       th:href="@{/quan-ly-khuyen-mai(page=${khuyenMaiPage.number - 1}, size=${khuyenMaiPage.size})}">&laquo;</a>
                    <span class="current-page" th:text="${khuyenMaiPage.number + 1}"></span>
                    <a class="next" th:if="${khuyenMaiPage.hasNext()}"
                       th:href="@{/quan-ly-khuyen-mai(page=${khuyenMaiPage.number + 1}, size=${khuyenMaiPage.size})}">&raquo;</a>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>
</main>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        const formElement = document.getElementById('form-add-promotion');

        formElement.addEventListener('submit', async function (event) {
            event.preventDefault();

            // Lấy và kiểm tra các phần tử input từ form
            const fields = {
                maKhuyenMai: formElement.maKhuyenMai.value.trim(),
                tenKhuyenMai: formElement.tenKhuyenMai.value.trim(),
                soLuong: parseInt(formElement.soLuong.value, 10),
                giamGia: parseFloat(formElement.giamGia.value),
                loaiGiam: formElement.loaiGiam.value,
                giamToiThieu: parseFloat(formElement.giamToiThieu.value),
                giamToiDa: parseFloat(formElement.giamToiDa.value),
                moTa: formElement.moTa.value.trim(),
                ngayBatDau: new Date(formElement.ngayBatDau.value),
                ngayKetThuc: new Date(formElement.ngayKetThuc.value)
            };

            // Log giá trị giamGia để kiểm tra
            console.log("Giảm giá:", fields.giamGia);

            // Kiểm tra phần trăm giảm giá không vượt quá 100%
            if (fields.loaiGiam === 'true' && fields.giamGia > 100) {
                showErrorToast('Giảm giá phần trăm không thể vượt quá 100%.');
                return; // Dừng thực hiện nếu có lỗi
            }

            // Kiểm tra đầu vào
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (Object.values(fields).some(value => !value && value !== 0)) {
                showErrorToast('Vui lòng điền đầy đủ thông tin.');
                return;
            }
            const specialCharPattern = /[^\p{L}\p{N}\s]/u;
            const whiteSpacePattern = /^\s*$/; // Kiểm tra chuỗi chỉ chứa khoảng trắng

            if (specialCharPattern.test(fields.tenKhuyenMai)) {
                showErrorToast('Tên khuyến mãi không được chứa ký tự đặc biệt.');
                return;
            }

            if (whiteSpacePattern.test(fields.tenKhuyenMai)) {
                showErrorToast('Tên khuyến mãi không được nhập toàn khoảng trắng.');
                return;
            }
            if (fields.soLuong <= 0) {
                showErrorToast('Số lượng phải lớn hơn 0.');
                return;
            }
            if (fields.giamGia < 0 || fields.giamToiThieu < 0) {
                showErrorToast('Giảm giá và giá tối thiểu phải lớn hơn hoặc bằng 0.');
                return;
            }
            if (fields.giamToiDa < fields.giamToiThieu) {
                showErrorToast('Giá tối đa phải lớn hơn hoặc bằng giá tối thiểu.');
                return;
            }
            if (isNaN(fields.ngayBatDau) || fields.ngayBatDau < today) {
                showErrorToast('Ngày bắt đầu phải lớn hơn hoặc bằng ngày hiện tại.');
                return;
            }
            if (isNaN(fields.ngayKetThuc) || fields.ngayKetThuc < fields.ngayBatDau) {
                showErrorToast('Ngày kết thúc phải lớn hơn ngày bắt đầu.');
                return;
            }

            // Gửi dữ liệu nếu hợp lệ
            try {
                const formData = new FormData(formElement);
                const response = await fetch('/quan-ly-khuyen-mai/add', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();

                if (data.success) {
                    showSuccessToast('Thêm khuyến mãi thành công!');
                    $('#addKhuyenMaiModal').modal('hide');
                    formElement.reset();
                    setTimeout(() => {
                        location.reload(); // Reload trang sau khi hiển thị thông báo thành công
                    }, 1500);
                } else if (data.error) {
                    showErrorToast(data.error);
                }
            } catch (error) {
                showErrorToast('Đã có lỗi xảy ra: ' + error.message);
                console.error(error.message);
            }
        });

        const formEdit = document.getElementById("editKhuyenMaiForm");
        formEdit.addEventListener('submit', async function (event) {
            event.preventDefault();

            const fields = {
                maKhuyenMai: formEdit.maKhuyenMai.value.trim(),
                tenKhuyenMai: formEdit.tenKhuyenMai.value.trim(),
                soLuong: parseInt(formEdit.soLuong.value, 10),
                giamGia: parseFloat(formEdit.giamGia.value),
                loaiGiam: formEdit.editLoaiGiam.value,
                giamToiThieu: parseFloat(formEdit.giamToiThieu.value),
                giamToiDa: parseFloat(formEdit.giamToiDa.value),
                moTa: formEdit.moTa.value.trim(),
                ngayBatDau: new Date(formEdit.ngayBatDau.value),
                ngayKetThuc: new Date(formEdit.ngayKetThuc.value)
            };

            if (fields.loaiGiam === 'true' && fields.giamGia > 100) {
                showErrorToast('Giảm giá phần trăm không thể vượt quá 100%.');
                return; // Dừng thực hiện nếu có lỗi
            }

            // Kiểm tra đầu vào
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (Object.values(fields).some(value => !value && value !== 0)) {
                showErrorToast('Vui lòng điền đầy đủ thông tin.');
                return;
            }
            const specialCharPattern = /[^\p{L}\p{N}\s]/u;
            const whiteSpacePattern = /^\s*$/; // Kiểm tra chuỗi chỉ chứa khoảng trắng

            if (specialCharPattern.test(fields.tenKhuyenMai)) {
                showErrorToast('Tên khuyến mãi không được chứa ký tự đặc biệt.');
                return;
            }

            if (whiteSpacePattern.test(fields.tenKhuyenMai)) {
                showErrorToast('Tên khuyến mãi không được nhập toàn khoảng trắng.');
                return;
            }
            if (fields.soLuong <= 0) {
                showErrorToast('Số lượng phải lớn hơn 0.');
                return;
            }
            if (fields.giamGia < 0 || fields.giamToiThieu < 0) {
                showErrorToast('Giảm giá và giá tối thiểu phải lớn hơn hoặc bằng 0.');
                return;
            }
            if (fields.giamToiDa < fields.giamToiThieu) {
                showErrorToast('Giá tối đa phải lớn hơn hoặc bằng giá tối thiểu.');
                return;
            }
            if (isNaN(fields.ngayBatDau) || fields.ngayBatDau < today) {
                showErrorToast('Ngày bắt đầu phải lớn hơn hoặc bằng ngày hiện tại.');
                return;
            }
            if (isNaN(fields.ngayKetThuc) || fields.ngayKetThuc < fields.ngayBatDau) {
                showErrorToast('Ngày kết thúc phải lớn hơn ngày bắt đầu.');
                return;
            }
            const id = document.getElementById("editId").value;
            const url = `/quan-ly-khuyen-mai/update/${id}`;
            const formData = new FormData(formEdit);
            fetch(url, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessToast("Cập nhật khuyến mãi thành công!");
                        // Đóng modal và làm mới danh sách nếu cần
                        $('#editKhuyenMaiModal').modal('hide');
                        setTimeout(() => {
                            location.reload(); // Reload trang sau khi hiển thị thông báo thành công
                        }, 1500);
                    } else {
                        showErrorToast(data.error || "Đã có lỗi xảy ra");
                    }
                })
                .catch(error => {
                    alert("Lỗi kết nối: " + error.message);
                });
        });
    });

    function showSuccessToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#4CAF50" // Sử dụng style.background thay cho backgroundColor
            },
            stopOnFocus: true
        }).showToast();
    }

    // Hàm hiển thị toast thông báo khi lỗi
    function showErrorToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#f44336" // Sử dụng style.background thay cho backgroundColor
            },
            stopOnFocus: true
        }).showToast();
    }


    function generateMaKhuyenMai() {
        var length = 6; // Độ dài của mã khuyến mãi
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'; // Chỉ sử dụng chữ cái
        var result = '';
        var charactersLength = characters.length;

        for (var i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        // Gán mã khuyến mãi mới vào input
        document.getElementById('maKhuyenMai').value = result;
    }


    function setModalData(button) {
        document.getElementById('editId').value = button.getAttribute('data-idKhuyenMai');
        document.getElementById('editMaKhuyenMai').value = button.getAttribute('data-maKhuyenMai');
        document.getElementById('editTenKhuyenMai').value = button.getAttribute('data-tenKhuyenMai');
        document.getElementById('editMoTa').value = button.getAttribute('data-moTa');
        document.getElementById('editSoLuong').value = button.getAttribute('data-soLuong');
        document.getElementById('editGiamGia').value = button.getAttribute('data-giamGia');
        document.getElementById('editGiamToiThieu').value = button.getAttribute('data-giamToiThieu');
        document.getElementById('editGiamToiDa').value = button.getAttribute('data-giamToiDa');
        document.getElementById('editNgayBatDau').value = button.getAttribute('data-ngayBatDau');
        document.getElementById('editNgayKetThuc').value = button.getAttribute('data-ngayKetThuc');
        document.getElementById('editLoaiGiam').value = button.getAttribute('data-loaiGiam');
        document.getElementById('editTrangThai').value = button.getAttribute('data-trangThai');
    }

    $(document).ready(function() {
        $('.open-update-modal').on('click', function() {
            var khuyenMaiId = $(this).data('id'); // Lấy ID từ thuộc tính data-id
            openUpdateModal(khuyenMaiId); // Gọi hàm với ID
        });
    });


    function openUpdateModal(id) {
        // Gửi yêu cầu AJAX để lấy dữ liệu khuyến mãi
        fetch(`/quan-ly-khuyen-mai/update/${id}`)
            .then(response => response.json())
            .then(data => {
                // Gán giá trị cho các trường trong modal
                document.getElementById('khuyenMaiId').value = data.id;
                document.getElementById('maKhuyenMai').value = data.maKhuyenMai;
                document.getElementById('tenKhuyenMai').value = data.tenKhuyenMai;
                document.getElementById('moTa').value = data.moTa;
                document.getElementById('soLuong').value = data.soLuong;
                document.getElementById('giamGia').value = data.giamGia;
                document.getElementById('giamToiThieu').value = data.giamToiThieu;
                document.getElementById('giamToiDa').value = data.giamToiDa;
                document.getElementById('ngayBatDau').value = data.ngayBatDau.split('T')[0]; // Chỉ lấy ngày
                document.getElementById('ngayKetThuc').value = data.ngayKetThuc.split('T')[0]; // Chỉ lấy ngày
                document.getElementById('loaiGiam').value = data.loaiGiam ? 'phanTram' : 'tienMat';
                document.getElementById('trangThai').value = data.trangThai;
                // document.getElementById('trangThaiConHan').checked = khuyenMai.trangThai === 'Còn hạn';
                // document.getElementById('trangThaiHetHan').checked = khuyenMai.trangThai === 'Hết hạn';
                // document.getElementById('trangThaiSapDienRa').checked = khuyenMai.trangThai === 'Sắp diễn ra';
                // Mở modal
                $('#updateModal').modal('show');
            })
            .catch(error => console.error('Error:', error));
    }


    // function updateKhuyenMai() {
    //     const form = document.getElementById("editKhuyenMaiForm");
    //     const formData = new FormData(form);
    //
    //     const id = document.getElementById("editId").value; // Lấy ID từ modal
    //     const url = `/quan-ly-khuyen-mai/update/${id}`; // API path
    //
    //     fetch(url, {
    //         method: 'POST',
    //         body: formData
    //     })
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success) {
    //                 showSuccessToast("Cập nhật khuyến mãi thành công!");
    //                 // Đóng modal và làm mới danh sách nếu cần
    //                 $('#editKhuyenMaiModal').modal('hide');
    //             } else {
    //                 showErrorToast(data.error || "Đã có lỗi xảy ra");
    //             }
    //         })
    //         .catch(error => {
    //             alert("Lỗi kết nối: " + error.message);
    //         });
    //
    //     return false; // Ngừng hành động mặc định của form
    // }


    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.form-check-input');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);

        checkboxes.forEach(checkbox => checkbox.checked = !allChecked);

        // Đổi nội dung nút sau khi bấm
        selectAllBtn.textContent = allChecked ? 'Chọn tất cả' : 'Bỏ chọn tất cả';
    }


    function searchInModal() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("modalSearchInput");
        filter = input.value.trim().toUpperCase();
        table = document.querySelector(".modal-body table");
        tr = table.getElementsByTagName("tr");

        // Lặp qua tất cả các hàng, ẩn những hàng không khớp với tìm kiếm
        for (i = 1; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1]; // Cột Tên khách hàng (hoặc thay bằng cột bạn muốn tìm kiếm)
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    document.getElementById('sendEmailBtn').addEventListener('click', function() {
        const selectedKhachHangList = []; // Danh sách khách hàng đã chọn
        const checkboxes = document.querySelectorAll('.form-check-input:checked'); // Tìm tất cả checkbox đã được chọn

        // Lặp qua từng checkbox đã chọn
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr'); // Lấy hàng tương ứng với checkbox
            const khachHang = {
                hoVaTen: row.querySelector('td:nth-child(2)').innerText, // Lấy tên khách hàng từ cột thứ hai
                email: row.querySelector('td:nth-child(3)').innerText // Lấy email từ cột thứ ba
            };
            console.log(khachHang); // Hiển thị thông tin khách hàng trong console
            selectedKhachHangList.push(khachHang); // Thêm khách hàng vào danh sách đã chọn
        });

        const voucherId = document.getElementById('voucherId').value; // Lấy mã voucher

        // Kiểm tra xem có khách hàng nào được chọn và mã voucher không
        if (selectedKhachHangList.length === 0 || !voucherId) {
            showErrorToast("Vui lòng chọn ít nhất một khách hàng và một mã voucher.");
            return; // Dừng thực thi nếu không đủ điều kiện
        }

        // Gửi dữ liệu qua API
        fetch('/api/sendemails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                voucherId: voucherId, // Gửi mã voucher
                khachHangList: selectedKhachHangList // Gửi danh sách khách hàng
            })
        })
            .then(response => {
                // Kiểm tra nếu phản hồi không phải JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json(); // Nếu là JSON, parse dữ liệu như bình thường
                } else {
                    return response.text(); // Nếu không phải JSON, trả về text
                }
            })
            .then(data => {
                if (typeof data === 'string') {
                    alert(data); // Hiển thị thông báo khi dữ liệu trả về là chuỗi văn bản
                } else {
                    showSuccessToast('Email đã được gửi thành công'); // Hiển thị thông báo gửi email thành công
                }
                $('#add').modal('hide'); // Đóng modal

                // Reset các trường và bỏ chọn checkbox
                document.getElementById('voucherId').value = ''; // Reset dropdown voucher
                checkboxes.forEach(checkbox => checkbox.checked = false); // Bỏ chọn tất cả các checkbox
                document.getElementById('modalSearchInput').value = ''; // Xóa nội dung tìm kiếm
                const rows = document.querySelectorAll('.modal-body table tr');
                rows.forEach(row => row.style.display = ''); // Hiển thị lại tất cả các hàng trong bảng

            })
            .catch(error => {
                alert('Lỗi: ' + error.message); // Hiển thị thông báo lỗi nếu có
                console.error('Error:', error); // In lỗi ra console
            });
    });
    function searchKhuyenMai() {
        const keyword = document.getElementById('searchInput').value.trim().toLowerCase(); // Từ khóa tìm kiếm
        const selectedTrangThai = document.getElementById('trangThai').value; // Trạng thái đã chọn
        const page = 0; // Trang đầu tiên
        const size = 5; // Số lượng bản ghi trên mỗi trang

        // Gọi API với từ khóa tìm kiếm và trạng thái
        fetch(`/quan-ly-khuyen-mai/search?keyword=${encodeURIComponent(keyword)}&trangThai=${encodeURIComponent(selectedTrangThai)}&page=${page}&size=${size}`)
            .then(response => response.json())
            .then(data => {
                displayKhuyenMais(data.content); // Hiển thị danh sách khuyến mãi từ phản hồi
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function displayKhuyenMais(khuyenMais) {
        const tableBody = document.getElementById('khuyenMaiTableBody');
        tableBody.innerHTML = '';
        khuyenMais.forEach(khuyenMai => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${khuyenMai.maKhuyenMai}</td>
            <td>${khuyenMai.tenKhuyenMai}</td>
            <td>${khuyenMai.giamGia}</td>
            <td>${khuyenMai.loaiGiam ? 'Phần Trăm' : 'Tiền Mặt'}</td>
            <td>${khuyenMai.soLuong}</td>
            <td class="format-number">${khuyenMai.giamToiThieu}</td>
            <td class="format-number">${khuyenMai.giamToiDa}</td>
            <td>${khuyenMai.trangThai}</td>
            <td>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editKhuyenMaiModal"
                                                onclick="setModalData(this)">
                                            <i class="fas fa-edit"></i> Sửa
                                        </button>

        `;
            tableBody.appendChild(row); // Thêm hàng mới vào bảng
        });

        // Hiện hoặc ẩn bảng dựa trên có kết quả hay không
        const originalTableContainer = document.querySelector('.table-container');
        originalTableContainer.style.display = khuyenMais.length > 0 ? 'block' : 'none';
        const elementt = document.querySelectorAll('.format-number');
        elementt.forEach(function (element) {
            const rawNumber = parseFloat(element.textContent.trim());
            if (!isNaN(rawNumber)) {
                element.textContent = rawNumber.toLocaleString('vi-VN'); // Định dạng số theo chuẩn Việt Nam
            }
        });
    }

</script>

</body>
</html>
