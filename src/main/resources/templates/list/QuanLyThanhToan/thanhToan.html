<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê doanh thu</title>
    <!-- Thêm thư viện Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Thêm thư viện jsPDF từ CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>



    <style>

        #errorMessage {
            display: none;
            /* Ẩn mặc định */

            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px;
            background-color: rgba(255, 0, 0, 0.8);
            /* Màu đỏ translucent */

            color: white;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 16px;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }

        body {
            background-color: #f8f9fa;
            /* Màu nền nhạt */

            color: #856404;
            /* Màu chữ cảnh báo */

            font-family: Arial, sans-serif;
        }

        h1 {
            color: #856404;
            /* Màu tiêu đề cảnh báo */

            text-align: center;
            margin-top: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        button {
            margin: 0 10px;
        }

        .chart-container {
            width: 70%;
            margin: 0 auto;
        }

        .revenue-display {
            text-align: center;
            font-size: 1.5rem;
            color: #fd7e14;
            /* Màu cảnh báo đậm */

            margin-bottom: 20px;
        }

        .card {
            width: 100%; /* Hoặc chiều rộng tùy ý */
            margin: 10px; /* Khoảng cách giữa các card */
        }

        .card-deck .card {
            flex: 1 0 auto; /* Để các card tự động giãn ra theo chiều ngang */
        }

        table {
            font-size: 13px; /* Kích thước chữ nhỏ hơn */
        }

        th, td {
            padding: 8px; /* Đảm bảo bảng vẫn có khoảng cách hợp lý */
            text-align: center; /* Căn giữa nội dung */
        }

        /* Tùy chọn thêm: giảm khoảng cách giữa các hàng */
        tr {
            line-height: 1.2; /* Điều chỉnh chiều cao dòng để phù hợp với kích thước chữ */
        }
        /* Basic styling for pagination container */


        /* Pagination buttons */
        #paginationContainer a {
            text-decoration: none;
            padding: 5px 10px;
            margin: 0 3px;
            border-radius: 3px;
            font-size: 14px;
            border: 1px solid #007bff;
            cursor: pointer;
        }
    </style>

    <head th:include="fragment/head :: head"></head>
</head>

<body class="vertical light">
<div th:include="fragment/navbar :: navbar"></div>
<div th:include="fragment/sidebar :: sidebar"></div>

<main role="main" class="main-content">


    <div class="container-fluid">
        <!-- Thông báo lỗi translucent -->
        <!--        <div id="errorMessage"></div>-->

        <div class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorMessage">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>

        <div class="d-flex justify-content-center">
            <h2 style="color: #0d4bdb">Danh Sách Hóa Dơn Cần Thanh Toán</h2>
        </div>

        <div class="row">
            <!-- Cột bên trái: Bảng -->
            <div class="col-md-6">
                <div class="py-4">
                    <div class="card p-4 shadow-sm">
                        <h4 class=" d-flex justify-content-center" style="color: black;">Danh sách đã cọc</h4>
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card-deck flex-wrap p-1">
                                    <div th:each="datPhong : ${datPhongs}" th:if="${datPhong.tinhTrang == 'Đã Checkin'}"
                                         th:data-id-dat-phong="${datPhong.idDatPhong}"
                                         th:data-id-phong="${datPhong.phong.idPhong}"
                                         th:data-id-loai-phong="${datPhong.loaiPhong.idLoaiPhong}"
                                         th:data-hovaten="${datPhong.khachHang.hoVaTen}"
                                         th:data-sodienthoai="${datPhong.khachHang.soDienThoai}"
                                         th:data-tenphong="${datPhong.phong.tenPhong}"
                                         th:data-thoigian="${datPhong.ngayNhan} + ' - ' + ${datPhong.ngayTra}"
                                         th:data-ngaycheckin="${#temporals.format(datPhong.ngayCheckIn,'HH:mm - dd/MM/yyyy')}"
                                         th:data-giaphong="${datPhong.phong.loaiPhong.gia}"
                                         th:data-tiencoc="${datPhong.tienCoc}"
                                         th:data-tienconlai="${datPhong.tienConLai}"
                                         th:data-tongTien="${datPhong.tongTien}"
                                         class="card mb-3"
                                         onclick="showForm(this.getAttribute('data-id-dat-phong'),
                            this.getAttribute('data-id-phong'),
                            this.getAttribute('data-id-loai-phong'),
                            this.getAttribute('data-hovaten'),
                            this.getAttribute('data-sodienthoai'),
                            this.getAttribute('data-tenphong'),
                            this.getAttribute('data-thoigian'),
                            this.getAttribute('data-ngaycheckin'),
                            this.getAttribute('data-giaphong'),
                            this.getAttribute('data-tiencoc'),
                            this.getAttribute('data-tienconlai'),
                             this.getAttribute('data-tongTien'),
                            this)">
                                        <div class="card-body">
                                            <h5 class="card-title" th:text="${datPhong.khachHang.hoVaTen}"></h5>
                                            <p class="card-text">
                                                <strong>Mã đặt phòng:</strong> <span th:text="${datPhong.maDatPhong}"></span>
                                            </p>
                                            <p class="card-text mb-2">
                                                <strong>Phòng:</strong> <span th:text="${datPhong.phong.tenPhong}"></span>
                                            </p>
                                            <p class="card-text mb-2">
                                                <strong>Số điện thoại:</strong> <span th:text="${datPhong.khachHang.soDienThoai}"></span>
                                            </p>
                                            <p class="card-text mb-2">
                                                <strong>Ngày nhận phòng:</strong> <span th:text="${datPhong.ngayNhan}"></span>
                                            </p>
                                            <p class="card-text mb-2">
                                                <strong>Trạng thái:</strong> <span th:text="${datPhong.trangThai == 0 ? 'Đã Thanh Toán' : 'Đã Cọc'}"></span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phân trang Bootstrap -->
                        <nav class="d-flex justify-content-end">
                            <ul class="pagination pagination-sm">
                                <!-- Previous Page -->
                                <li th:if="${currentPage > 1}" class="page-item">
                                    <a class="page-link" th:href="@{/thanhToan(page=${currentPage - 1})}" aria-label="Previous">&laquo;</a>
                                </li>
                                <!-- Page Numbers -->
                                <li th:each="i : ${#numbers.sequence(0, totalPagesDatPhong)}"
                                    th:classappend="${i == currentPage} ? 'active' : ''" class="page-item">
                                    <a class="page-link" th:href="@{/thanhToan(page=${i})}" th:text="${i}"></a>
                                </li>
                                <!-- Next Page -->
                                <li th:if="${currentPage < totalPagesDatPhong}" class="page-item">
                                    <a class="page-link" th:href="@{/thanhToan(page=${currentPage + 1})}" aria-label="Next">&raquo;</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>



                <div class="col-md-6">
                    <div class="form-group">
                        <div class="input-group">
                            <!-- Tạo nhóm input với icon tìm kiếm -->
                            <div class="input-group-prepend">
                <span class="input-group-text bg-primary text-white">
                    <i class="fas fa-search"></i>
                </span>
                            </div>
                            <input type="text" id="keyword" name="keyword" class="form-control" placeholder="Tìm kiếm" oninput="searchChekin()" aria-label="Tìm kiếm">
                        </div>
                        <!-- Thêm text mô tả để người dùng biết họ đang tìm kiếm gì -->
                        <small id="keywordHelp" class="form-text text-muted">Nhập mã,tên khách hàng để tìm kiếm thông tin.</small>
                    </div>
                </div>

                <div id="resultArea">
                    <!-- Kết quả tìm kiếm sẽ được cập nhật ở đây -->
                </div>
                <div class="">
                    <div class="card p-4 shadow-sm">
                        <h4 class="d-flex justify-content-center" style="color:black;">Lịch Sử Thanh Toán</h4>
                        <hr>
                        <!-- Bảng hiển thị lịch sử thanh toán -->
                        <table class="table table-bordered" id="dataTable-1">
                            <thead class="thead-light">
                            <tr>
                                <th>Mã</th>
                                <th>Ngày</th>
                                <th>Phòng</th>
                                <th>Khách Hàng</th>
                                <th>Số Tiền</th>
                                <th>Trạng Thái</th>
                                <th>Nhân Viên</th>
                            </tr>
                            </thead>
                            <tbody id="transactionTableBody">
                            <!-- Nội dung bảng sẽ được thêm vào đây qua JavaScript -->
                            </tbody>
                            <tr id="noDataRow" style="display: none;">
                                <td colspan="4" class="text-center">Chưa có lịch sử thanh toán nào.</td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- Phân trang -->
                        <div id="paginationContainer" class=" mb-3">  </div>




                    </div>
                </div>
            </div>


            <!-- Cột bên phải: Form -->
            <div class="col-md-6">

                <div class="py-4">
                    <form th:action="@{/thanhToan/add}" method="post" th:object="${thanhToanDTO}" id="formId" class="card p-4 shadow-sm"  onsubmit="return false;">
                        <h4 style="color: black" class="d-flex justify-content-between align-items-center">
                            Thông tin hóa đơn
                            <button type="reset" class="btn btn-danger btn-sm" onclick="restfrom()">
                                <i class="fas fa-sync-alt"></i> Reset
                            </button>
                        </h4>

                        <hr>
                        <input type="hidden" id="idDatPhong" th:field="*{idDatPhong}">
                        <input type="hidden" id="idPhong" th:field="*{idPhong}">
                        <input type="hidden" id="idLoaiPhong" th:field="*{idLoaiPhong}">
                        <input type="hidden" id="idKhuyenMai" th:field="*{idKhuyenMai}">


                        <!-- Thông tin khách hàng -->
                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col-6 mb-3">
                                <label for="hoVaTen" class="form-label font-weight-bold">Khách hàng</label>
                                <input type="text" name="hoVaTen" id="hoVaTen" class="form-control form-control-sm" disabled>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="soDienThoai" class="form-label font-weight-bold">Số điện thoại</label>
                                <input type="text" name="soDienThoai" id="soDienThoai" class="form-control form-control-sm" disabled>
                            </div>
                        </div>

                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col-6 mb-3">
                                <label for="tenphong" class="form-label font-weight-bold">Tên phòng</label>
                                <input type="text" id="tenphong" class="form-control form-control-sm" disabled>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="thoiGian" class="form-label font-weight-bold">Thời gian</label>
                                <input type="text" id="thoiGian" class="form-control form-control-sm" disabled>
                            </div>
                        </div>

                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col-6 mb-3">
                                <label for="ngayCheckIn" class="form-label font-weight-bold">Thời gian check-in</label>
                                <input type="text" name="ngayCheckIn" id="ngayCheckIn" class="form-control form-control-sm" disabled>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="giaPhong" class="form-label font-weight-bold">Giá phòng</label>
                                <div class="input-group">
                                    <input type="text" name="gia" id="giaPhong" class="form-control form-control-sm" disabled>
                                    <span class="input-group-text form-control-sm" style="font-size: 0.875rem;">VND</span>
                                </div>
                            </div>
                        </div>

                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col-6 mb-3">
                                <label for="tienPhuPhi" class="form-label font-weight-bold">Tiền phụ phí</label>
                                <div class="input-group">
                                    <input type="text" id="tienPhuPhi" class="form-control form-control-sm" readonly>
                                    <span class="input-group-text form-control-sm" style="font-size: 0.875rem;">VND</span>
                                </div>
                            </div>

                            <div class="col-6 mb-3">
                                <label for="voucherId">Khuyến mại </label>
                                <select class="form-control" id="voucherId" name="voucherId"  onchange="tinhTongTien()">
                                    <option value="" disabled selected>-- Chọn khuyến mại --</option>
                                    <option th:each="voucher : ${activeVouchers}"
                                            th:if="${voucher.soLuong > 0}"
                                            th:value="${voucher.idKhuyenMai}"
                                            th:data-muc-giam="${voucher.giamGia}"
                                            th:data-so-luong="${voucher.soLuong}"
                                            th:data-loai-giam="${voucher.loaiGiam ? 'true' : 'false'}"
                                            th:data-giam-toi-thieu="${voucher.giamToiThieu}"
                                            th:data-giam-toi-da="${voucher.giamToiDa}"
                                            th:text="${voucher.maKhuyenMai} + ' - Giảm giá:' + ${#numbers.formatDecimal(voucher.giamGia, 0, '0')}+ (${voucher.loaiGiam ? '%' : 'VND'})"></option>
                                </select>
                            </div>
                        </div>



                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col-6 mb-3">
                                <label for="tienCoc" class="form-label font-weight-bold">Tiền cọc phòng</label>
                                <div class="input-group">
                                    <input type="text" name="tienCoc" id="tienCoc" class="form-control form-control-sm" readonly>
                                    <span class="input-group-text form-control-sm" style="font-size: 0.875rem;">VND</span>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="tienCoc" class="form-label font-weight-bold">Tổng tiền phòng</label>
                                <div class="input-group">
                                    <input type="text" name="tongTien" id="tongTien" class="form-control form-control-sm" disabled>
                                    <span class="input-group-text form-control-sm" style="font-size: 0.875rem;">VND</span>
                                </div>
                            </div>

                        </div>




                        <!-- Thông tin thanh toán -->
                        <h4 class="">Thanh toán</h4>
                        <hr>
                        <div class="mb-3 pb-2 d-flex align-items-center border-bottom">
                            <label for="phuPhiSelect" class="form-label me-2 font-weight-bold">Phụ phí</label>
                            <div class="input-group col-8 ms-auto">
                                <select onchange="phuPhiChange(this);tinhTongTien();" class="form-select form-control-sm" id="phuPhiSelect" name="phuPhi">
                                    <option value="Không có phụ thu nào" disabled selected>Chọn phụ phí</option>
                                    <option th:each="phuPhi : ${phuPhis}" th:value="${phuPhi.idPhuPhi}" th:text="${phuPhi.tenPhuPhi}" th:data-giaphuphi="${phuPhi.giaPhuPhi}">
                                    </option>
                                </select>
                                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalPhuPhi" style="font-weight: bold;">+
                                </button>
                            </div>
                        </div>

                        <div class="mb-3 border-bottom">
                            <label class="form-label font-weight-bold">Phương thức: </label>
                            <div class="form-check form-check-inline">
                                <input type="radio" name="phuongThuc" id="tienMat" value="true" class="form-check-input" onclick="toggleTienMatFields(true); generateQR(false)" checked>
                                <label for="tienMat" class="form-check-label font-weight-bold">Tiền mặt</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input type="radio" name="phuongThuc" id="chuyenKhoan" value="false" class="form-check-input" onclick="toggleTienMatFields(false)">
                                <label for="chuyenKhoan" class="form-check-label font-weight-bold">Chuyển khoản</label>
                            </div>
                        </div>

                        <div id="qrCodeDisplay"></div>


                        <div id="tienMatFields" class="border-bottom">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="soTienKhachDua" class="form-label font-weight-bold">Số tiền khách đưa</label>
                                    <input type="number" id="soTienKhachDua" class="form-control" oninput="tinhTienThua()" required>
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="tienThua" class="form-label font-weight-bold">Tiền thừa</label>
                                    <input type="number" id="tienThua" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="form-group border-bottom pb-2 mb-3">
                            <label for="printInvoice" class="form-label font-weight-bold">In hóa đơn</label>
                            <div class="form-switch">
                                <input class="form-check-input" type="checkbox" id="printInvoice" name="inHoaDon">
                                <label class="form-check-label" for="printInvoice">In hóa đơn</label>
                            </div>
                        </div>



                        <div class="mb-3">
                            <label for="tienConLai" class="form-label">Tổng phải thanh toán</label>
                            <div class="input-group">
                                <input type="number" name="soTien" id="tienConLai" class="form-control" readonly>
                                <span class="input-group-text">VND</span>
                            </div>
                        </div>

                        <input type="hidden" name="tinhTrang" id="daThanhToan" value="true">
                        <div>
                            <button type="submit" class="btn btn-success" onclick="kiemTraThanhToan(document.getElementById('idDatPhong').value)">
                                <i class="fas fa-dollar-sign"></i> Thanh toán
                            </button>
                        </div>
                    </form>
                </div>

            </div>



            <!-- Modal -->
            <div class="modal fade" id="modalPhuPhi" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: orange">
                            <h5 class="modal-title" id="staticBackdropLabelUpdate">Thêm phụ phí</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formPhuPhi" class="p-3 border rounded shadow-sm bg-light">
                                <h4 class="mb-3">Thêm phụ phí</h4>
                                <input type="hidden" name="idDatPhong" id="datPhongId">
                                <div class="mb-3">
                                    <label for="tenPhuPhi" class="form-label">Tên phụ phí</label>
                                    <input type="text" name="tenPhuPhi" id="tenPhuPhi" class="form-control" placeholder="Nhập tên phụ phí" required>
                                </div>
                                <div class="mb-3">
                                    <label for="giaPhuPhi" class="form-label">Giá phụ phí</label>
                                    <input type="number" name="giaPhuPhi" id="giaPhuPhi" class="form-control" placeholder="Nhập giá phụ phí" required>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-success">Thêm phụ phí</button>
                                </div>

                            </form>

                            <div class="mt-5">
                                <!-- Kiểm tra nếu danh sách phụ phí rỗng -->
                                <!--                                <div th:each="phuPhi:${phuPhis}" th:if="${phuPhi.getDatPhong().idDatPhong == null}"  class="text-center text-muted">-->
                                <!--                                    Chưa có phụ phí nào-->
                                <!--                                </div>-->
                                <table class="table table-bordered table-striped shadow-sm">
                                    <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Tên phụ phí</th>
                                        <th scope="col">Giá phụ phí</th>
                                        <th scope="col">Id Đặt Phòng</th>
                                        <th scope="col">Thao tác</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="phuPhi, i : ${phuPhis}" data-bs-toggle="modal" data-bs-target="#modalUpdatePhuPhi" th:data-idphuphi="${phuPhi.idPhuPhi}" th:data-tenphuphi="${phuPhi.tenPhuPhi}" th:data-giaphuphi="${phuPhi.giaPhuPhi}" th:data-iddatphong="${phuPhi.datPhong.idDatPhong}" onclick="detailPhuPhi(this)">
                                        <td th:text="${i.count}"></td>
                                        <td th:text="${phuPhi.tenPhuPhi}"></td>
                                        <td th:text="${phuPhi.giaPhuPhi}"></td>
                                        <td th:text="${phuPhi.datPhong.idDatPhong}"></td>
                                        <td>
                                            <button type="button" th:onclick="deletePhuPhi('[[${phuPhi.idPhuPhi}]]')" class="btn btn-danger btn-sm">Xóa
                                            </button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>

                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--Update modal  -->
            <div class="modal fade" id="modalUpdatePhuPhi" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: orange">
                            <h5 class="modal-title" id="staticBackdropLabel">Sửa phụ phí</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formUpdatePhuPhi" class="p-3 border rounded shadow-sm bg-light">
                                <h4 class="mb-3">Thêm phụ phí</h4>
                                <input type="hidden" name="idDatPhong" id="datPhongIdDetail">
                                <input type="hidden" name="idPhuPhi" id="idPhuPhiDetail">
                                <div class="mb-3">
                                    <label for="tenPhuPhi" class="form-label">Tên phụ phí</label>
                                    <input type="text" name="tenPhuPhi" id="tenPhuPhiDetail" class="form-control" placeholder="Nhập tên phụ phí" required>
                                </div>
                                <div class="mb-3">
                                    <label for="giaPhuPhi" class="form-label">Giá phụ phí</label>
                                    <input type="number" name="giaPhuPhi" id="giaPhuPhiDetail" class="form-control" placeholder="Nhập giá phụ phí" required>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-success">Sửa phụ phí</button>
                                </div>
                            </form>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Thêm thư viện QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>

    document.addEventListener("DOMContentLoaded", function () {
        let currentPage = 0; // Initial page
        const pageSize = 5; // Page size

        // Function to fetch transactions based on the current page
        function fetchTransactions(page) {
            fetch(`/api/km/hienThi?page=${page}&size=${pageSize}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const transactions = data.content;
                    const totalPages = data.totalPages; // Total number of pages
                    const transactionTableBody = document.getElementById('transactionTableBody');
                    const noDataRow = document.getElementById('noDataRow');

                    // Clear previous rows
                    transactionTableBody.innerHTML = '';

                    if (transactions.length === 0) {
                        noDataRow.style.display = 'table-row'; // Show "No Data" message
                    } else {
                        noDataRow.style.display = 'none'; // Hide "No Data" message
                        transactions.forEach(transaction => {
                            const row = document.createElement('tr');

                            // Format ngayThanhToan to only show date
                            const formattedDate = transaction.ngayThanhToan
                                ? new Date(transaction.ngayThanhToan).toLocaleDateString()
                                : 'N/A';

                            // Format tongTien to currency with VND symbol
                            const formattedTongTien = formatPrice(transaction.tongTien || 0.00);

                            row.innerHTML = `
                        <td>${transaction.maThanhToan || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td>${transaction.tenPhong || 'N/A'}</td>
                        <td>${transaction.hoVaTen || 'N/A'}</td>
                        <td>${formattedTongTien}</td>
                        <td>${transaction.tinhTrang ? 'Đã Thanh Toán' : 'Chưa Thanh Toán'}</td>
                        <td>${transaction.hoTen || 'N/A'}</td>
                    `;
                            transactionTableBody.appendChild(row);
                        });
                    }

                    // Update pagination
                    updatePagination(page, totalPages);
                })
                .catch(error => console.error('Error fetching transactions:', error));
        }

        // Function to format price
        function formatPrice(price) {
            return price.toLocaleString('vi-VN', {
                style: 'currency',
                currency: 'VND'
            });
        }

        // Function to update pagination UI
        function updatePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            paginationContainer.innerHTML = ''; // Clear previous pagination

            if (totalPages > 1) {
                // Previous page button
                if (currentPage > 0) {
                    const prevButton = document.createElement('a');
                    prevButton.href = "#";
                    prevButton.className = 'btn btn-primary me-2';
                    prevButton.textContent = '<<';
                    prevButton.addEventListener('click', function (event) {
                        event.preventDefault(); // Prevent default link behavior
                        if (currentPage > 0) {
                            currentPage--;
                            fetchTransactions(currentPage); // Fetch data for the previous page
                        }
                    });
                    paginationContainer.appendChild(prevButton);
                }

                // Page number buttons
                for (let i = 0; i < totalPages; i++) {
                    const pageButton = document.createElement('a');
                    pageButton.href = "#";
                    pageButton.className = 'btn btn-outline-primary mx-1';
                    pageButton.textContent = i + 1;
                    if (i === currentPage) {
                        pageButton.classList.add('active'); // Highlight the current page
                    }
                    pageButton.addEventListener('click', function (event) {
                        event.preventDefault(); // Prevent default link behavior
                        currentPage = i;
                        fetchTransactions(currentPage); // Fetch data for the selected page
                    });
                    paginationContainer.appendChild(pageButton);
                }

                // Next page button
                if (currentPage < totalPages - 1) {
                    const nextButton = document.createElement('a');
                    nextButton.href = "#";
                    nextButton.className = 'btn btn-primary ms-2';
                    nextButton.textContent = '>>';
                    nextButton.addEventListener('click', function (event) {
                        event.preventDefault(); // Prevent default link behavior
                        if (currentPage < totalPages - 1) {
                            currentPage++;
                            fetchTransactions(currentPage); // Fetch data for the next page
                        }
                    });
                    paginationContainer.appendChild(nextButton);
                }
            }
        }

        // Initially fetch the first page of transactions
        fetchTransactions(currentPage);
    });


    //Lắng nghe sự kiến submit từ form
    document.getElementById("formPhuPhi").addEventListener('submit', function (event) {
        event.preventDefault(); // Ngăn chặn hành vi mặc định của form

        const idDatPhong = parseInt(document.getElementById('datPhongId').value, 10);
        const tenPhuPhi = document.getElementById('tenPhuPhi').value;
        const giaPhuPhi = parseFloat(document.getElementById('giaPhuPhi').value);

        // Kiểm tra dữ liệu đầu vào
        if (!idDatPhong || isNaN(idDatPhong)) {
            showError("Vui lòng nhập ID đặt phòng hợp lệ.");
            return;
        }
        if (!tenPhuPhi) {
            showError("Vui lòng nhập tên phụ phí.");
            return;
        }
        if (isNaN(giaPhuPhi)) {
            showError("Giá phụ phí phải là một số hợp lệ.");
            return;
        }

        // Gửi dữ liệu đến server
        fetch('/phuPhi/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `idDatPhong=${encodeURIComponent(idDatPhong)}
            &tenPhuPhi=${encodeURIComponent(tenPhuPhi)}
            &giaPhuPhi=${encodeURIComponent(giaPhuPhi)}`
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Đã xảy ra lỗi khi thêm phụ phí.');
                    });
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: data.success || 'Thông tin phụ phí đã được thêm thành công.',
                    showConfirmButton: true
                });
                // Cập nhật nội dung mà không tải lại trang
                // Ví dụ: thêm phụ phí vào một danh sách hiển thị hoặc làm mới một phần của trang
                document.getElementById('datPhongId').value = '';
                document.getElementById('tenPhuPhi').value = '';
                document.getElementById('giaPhuPhi').value = '';
                // Thêm phụ phí mới vào bảng
                const tableBody = document.querySelector('tbody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
            <td>${tableBody.children.length + 1}</td>
            <td>${tenPhuPhi}</td>
            <td>${giaPhuPhi}</td>
            <td>${idDatPhong}</td>
            <td>
                <a href="" class="btn btn-danger btn-sm">Xóa</a>
            </td>
        `;
                tableBody.appendChild(newRow);
            })
            .catch(error => {
                console.log("Lỗi khi gọi API: ", error);
                showError("Đã xảy ra lỗi: " + error.message);
            });
    });

    //xóa phuphi
    function deletePhuPhi(idPhuPhi) {
        if (confirm("Bạn có chắc chắn muốn xóa phụ phí này?")) {
            fetch(`/phuPhi/delete/${idPhuPhi}`, {
                method: 'DELETE', // Phương thức DELETE
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.text().then(text => {
                    console.log(text); // In phản hồi ra console
                    if (!response.ok) {
                        throw new Error('Đã xảy ra lỗi khi xóa phụ phí.');
                    }
                    try {
                        return JSON.parse(text); // Thử chuyển phản hồi thành JSON
                    } catch (error) {
                        throw new Error('Phản hồi từ server không phải là JSON.');
                    }
                }))
                .then(data => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: data.success,
                        showConfirmButton: true
                    }).then(() => {
                        // Reload lại trang hoặc cập nhật lại bảng dữ liệu phụ phí
                        location.reload(); // Tải lại trang để cập nhật thay đổi
                    });
                })
                .catch(error => {
                    console.log("Lỗi khi gọi API: ", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: error.message,
                        showConfirmButton: true
                    });
                });
        }
    }

    //detail phu phi
    function detailPhuPhi(button) {
        let idPhuPhi = button.getAttribute('data-idphuphi');
        let tenPhuPhi = button.getAttribute('data-tenphuphi');
        let giaPhuPhi = button.getAttribute('data-giaphuphi');
        let idDatPhong = button.getAttribute('data-iddatphong');

        document.getElementById('idPhuPhiDetail').value = idPhuPhi;
        document.getElementById('tenPhuPhiDetail').value = tenPhuPhi;
        document.getElementById('giaPhuPhiDetail').value = giaPhuPhi;
        document.getElementById('datPhongIdDetail').value = idDatPhong;

        console.log(idPhuPhi);
        console.log(idDatPhong);
        console.log(tenPhuPhi);
        console.log(giaPhuPhi);
    }

    //updatePhuPhi
    document.getElementById("formUpdatePhuPhi").addEventListener('submit', function (event) {
        event.preventDefault();

        const idPhuPhi = document.getElementById('idPhuPhiDetail').value;
        const idDatPhong = document.getElementById('datPhongIdDetail').value;
        const tenPhuPhi = document.getElementById('tenPhuPhiDetail').value;
        const giaPhuPhi = document.getElementById('giaPhuPhiDetail').value;

        fetch('phuPhi/update', {
            method: 'PUT',
            headers: {
                'content-type': 'application/x-www-form-urlencoded',

            },
            body: `idPhuPhi=${encodeURIComponent(idPhuPhi)}
                    &idDatPhong=${encodeURIComponent(idDatPhong)}
                    &tenPhuPhi=${encodeURIComponent(tenPhuPhi)}
                    &giaPhuPhi=${encodeURIComponent(giaPhuPhi)}`
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Đã xảy ra lỗi khi sửa phụ phí.');
                    });
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: data.success,
                    showConfirmButton: true
                });
            }).catch(error => {
            console.log(idPhuPhi, idDatPhong, tenPhuPhi, giaPhuPhi);
            console.log('Lỗi', error)
            showError('Đã xảy ra lỗi: ' + error.message);
        });

    });


    function showError(message) {
        Swal.fire({
            icon: 'error',
            title: 'Đã xảy ra lỗi!',
            text: message,
            showConfirmButton: true
        });
    }

    let selectedCard = null

    // Hàm này điền dữ liệu vào các input fields trong form
    function showForm(idDatPhong, idPhong, idLoaiPhong, hoVaTen,
                      soDienThoai, tenPhong, thoiGian, thoiGianCheckIn,
                      giaPhong, tienCoc, tienConLai, tongTien, cardElement) {

        if (selectedCard !== null) {
            // Nếu có thẻ phòng cũ đã được chọn và khuyến mãi đã áp dụng, cần hủy bỏ hoặc cập nhật lại
            if (isVoucherApplied) {
                // Hủy bỏ khuyến mãi cũ
                isVoucherApplied = false;
                document.getElementById('voucherId').disabled = false; // Bật lại trường chọn voucher
                document.getElementById('voucherId').value = ''; // Reset giá trị voucher đã chọn
                // Reset các giá trị liên quan đến giảm giá
                document.getElementById('tienConLai').value = tienConLai; // Cập nhật lại tổng tiền
            }
        }
        // Điền giá trị vào form
        document.getElementById('idDatPhong').value = idDatPhong;
        document.getElementById('idPhong').value = idPhong;
        document.getElementById('idLoaiPhong').value = idLoaiPhong;
        document.getElementById("hoVaTen").value = hoVaTen;
        document.getElementById("soDienThoai").value = soDienThoai;
        document.getElementById("tenphong").value = tenPhong;
        document.getElementById("thoiGian").value = thoiGian;
        document.getElementById("ngayCheckIn").value = thoiGianCheckIn;
        // Định dạng giá phòng, tiền cọc, tiền còn lại và tổng tiền thành tiền VNĐ
        document.getElementById("giaPhong").value = giaPhong;
        document.getElementById("tienCoc").value = tienCoc;

        document.getElementById("tongTien").value = tongTien;

        document.getElementById("tienConLai").value = tienConLai;
        // document.getElementById("soTien").value = tongTien;
        document.getElementById("datPhongId").value = idDatPhong;

        // Chuyển đổi giá trị tình trạng sang radio button phù hợp
        // if (tinhTrang === true) {
        //     document.getElementById("tinhTrang").value = true;
        // } else {
        //     document.getElementById("tinhTrang").value = false;
        // }


        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.classList.remove('bg-secondary');
        });

        // Thêm lớp 'bg-light' vào thẻ card đang được click
        cardElement.classList.add('bg-secondary');

        // Lưu trữ thông tin thẻ phòng đã chọn
        selectedCard = cardElement;

        console.log("Giá Phòng:", giaPhong); // Đây là giá phòng bạn cần lấy


    }

    function restfrom( tienConLai){
        // Hủy bỏ khuyến mãi cũ
        isVoucherApplied = false;
        document.getElementById('voucherId').disabled = false; // Bật lại trường chọn voucher
        document.getElementById('voucherId').value = ''; // Reset giá trị voucher đã chọn
        // Reset các giá trị liên quan đến giảm giá
        document.getElementById('tienConLai').value = tienConLai; // Cập nhật lại tổng tiền
        // Nếu có thẻ phòng cũ được chọn, xóa lớp 'bg-secondary'
        if (selectedCard !== null) {
            selectedCard.classList.remove('bg-secondary');  // Bỏ chọn thẻ cũ
        }

        // Reset selectedCard về null để không còn thẻ nào được chọn
        selectedCard = null;
    }


    // function formatCurrency(amount) {
    //     // Kiểm tra nếu amount không phải là kiểu float, chuyển đổi thành float
    //     let number = parseFloat(amount);
    //
    //     // Định dạng giá tiền theo kiểu VND mà không có ký hiệu đồng
    //     return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
    //         .format(number)
    //         .replace('₫', ''); // Loại bỏ ký hiệu đồng nếu không cần
    // }


    function phuPhiChange(selectElement) {
        const selectOption = selectElement.options[selectElement.selectedIndex];
        const giaPhuPhi = selectOption.getAttribute('data-giaphuphi');

        //gán vào ô input
        document.getElementById('tienPhuPhi').value = giaPhuPhi || '';
    }

    function toggleTienMatFields(isTienMat) {
        const tienMatFields = document.getElementById("tienMatFields");
        const qrCodeDisplay = document.getElementById("qrCodeDisplay");
        const tienConLai = document.getElementById("tienConLai");
        const soTienKhachDua = document.getElementById("soTienKhachDua");

        if (isTienMat) {
            tienMatFields.style.display = "block"; // Hiển thị trường tiền mặt
            qrCodeDisplay.innerHTML = ""; // Ẩn mã QR
            soTienKhachDua.value="";

        } else {
            tienMatFields.style.display = "none"; // Ẩn trường tiền mặt


            // Lấy số tiền còn lại và gán vào ô "Số tiền khách đưa"
            soTienKhachDua.value = tienConLai.value;
            // Lấy dữ liệu để tạo mã QR
            const accountNumber = "123456789"; // Số tài khoản ngân hàng
            const bankName = "BIDV"; // Tên ngân hàng (ở đây là BIDV)
            const amount = parseFloat(document.getElementById("tienConLai").value) || 0; // Lấy số tiền còn lại
            const note = "Thanh toán hóa đơn"; // Ghi chú giao dịch

            // Hiển thị mã QR
            displayQRCode(accountNumber, amount, note, bankName);
        }
    }


    function tinhTienThua() {
        // Lấy giá trị từ các ô input
        var soTienKhachDua = parseFloat(document.getElementById("soTienKhachDua").value) || 0;
        var tongSoTien = parseFloat(document.getElementById("tienConLai").value) || 0;

        // Tính tiền thừa
        var tienThua = soTienKhachDua - tongSoTien;

        // Cập nhật giá trị ô tiền thừa, nếu lớn hơn 0 thì hiển thị số tiền, nếu không thì giá trị là 0
        document.getElementById("tienThua").value = tienThua > 0 ? tienThua.toFixed(2) : 0;
    }

    function kiemTraThanhToan(idDatPhong) {
        console.log("ID Đặt Phòng:", idDatPhong); // Kiểm tra xem ID đặt phòng có được truyền vào không

        const soTienKhachDua = parseFloat(document.getElementById("soTienKhachDua").value) || 0;
        const tongSoTien = parseFloat(document.getElementById("tienConLai").value) || 0;

        // Kiểm tra số chữ số của "soTienKhachDua" không quá 10
        if (soTienKhachDua.toString().length > 10) {
            Swal.fire({
                title: 'Lỗi!',
                text: 'Số tiền khách đưa không được vượt quá 10 chữ số!',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            return false; // Ngăn không gửi form
        }

        // Kiểm tra số tiền khách đưa ít hơn tổng số tiền cần thanh toán
        if (soTienKhachDua < tongSoTien) {
            Swal.fire({
                title: 'Lỗi!',
                text: 'Số tiền khách đưa phải lớn hơn hoặc bằng tổng tiền còn lại!',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            return false; // Ngăn không gửi form
        }

        // Lấy mã khuyến mãi đã chọn (nếu có)
        const voucherSelect = document.getElementById('voucherId');
        const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
        const idKhuyenMai = selectedOption ? selectedOption.value : null;

        // Kiểm tra mã khuyến mãi
        if (idKhuyenMai) {
            const soLuongKhuyenMai = parseInt(selectedOption.getAttribute('data-so-luong'), 10);
            if (soLuongKhuyenMai <= 0) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Mã khuyến mại đã hết hiệu lực!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return; // Ngăn không gửi form
            }
        }

        // Kiểm tra nếu chưa chọn phòng
        if (!selectedCard) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn phòng!',
                text: 'Vui lòng chọn phòng trước khi thanh toán.',
                confirmButtonText: 'OK'
            });
            return; // Ngăn không gửi form
        }

        // Hiển thị thông báo xác nhận trước khi thực hiện thanh toán
        Swal.fire({
            title: 'Bạn chắc chắn muốn thanh toán?',
            text: "Hãy kiểm tra lại thông tin trước khi tiếp tục.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Có, thanh toán!',
            cancelButtonText: 'Hủy bỏ'
        }).then((result) => {
            if (result.isConfirmed) {
                // Thực hiện các bước thanh toán
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Thanh toán thành công!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(function () {
                    // Cập nhật số lượng mã khuyến mại nếu có mã khuyến mãi
                    if (idKhuyenMai) {
                        fetch(`/api/vouchers/update/${idKhuyenMai}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    console.log("Số lượng mã khuyến mại đã được cập nhật!");
                                } else {
                                    console.error(data.message || "Có lỗi xảy ra khi cập nhật số lượng khuyến mại.");
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi khi cập nhật số lượng mã khuyến mại:", error);
                            });
                    }

                    // Xóa CCCD của đặt phòng
                    fetch(`/datphongs/xoaCCCD/${idDatPhong}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log("CCCD đã được xóa thành công.");
                            } else {
                                throw new Error('Không thể xóa CCCD');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi khi xóa CCCD:', error);
                        });

                    // Xóa CCCD từ bảng NguoiDiCung
                    fetch(`/xoaTatCaCCCD/${idDatPhong}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log("CCCD trong bảng NguoiDiCung đã được xóa thành công.");
                            } else {
                                throw new Error('Không thể xóa CCCD trong bảng NguoiDiCung');
                            }
                        })
                        .catch(error => {
                            console.error('Lỗi khi xóa CCCD trong bảng NguoiDiCung:', error);
                        });


                    // Kiểm tra xem người dùng có chọn in hóa đơn không
                    const printInvoice = document.getElementById('printInvoice').checked;

                    if (printInvoice) {
                        // Gọi hàm in hóa đơn
                        inHoaDon();
                    }


                    // Gửi form sau khi các yêu cầu hoàn thành
                    document.getElementById("formId").submit();
                });
            }
        });
    }


    // Hàm in hóa đơn (in trực tiếp)
    function inHoaDon() {
        // Lấy thông tin từ form
        const hoVaTen = document.getElementById("hoVaTen").value;
        const soDienThoai = document.getElementById("soDienThoai").value;
        const tenPhong = document.getElementById("tenphong").value;
        const giaPhong = parseFloat(document.getElementById("giaPhong").value) || 0;
        const tienCoc = parseFloat(document.getElementById("tienCoc").value) || 0;
        const tongTien = parseFloat(document.getElementById("tongTien").value) || 0;
        const giaPhuPhi = parseFloat(document.getElementById("tienPhuPhi").value) || 0; // Lấy giá trị phụ phí
        const tienConLai = parseFloat(document.getElementById("tienConLai").value) || 0;
        const voucherSelect = document.getElementById("voucherId");
        const selectedVoucher = voucherSelect.options[voucherSelect.selectedIndex];

        // Lấy thông tin khuyến mãi (nếu có)
        let voucherDetails = "Không có khuyến mãi.";
        let giamGia = 0;
        let loaiGiam = '';

        if (selectedVoucher.value) {
            giamGia = selectedVoucher.getAttribute("data-muc-giam");
            loaiGiam = selectedVoucher.getAttribute("data-loai-giam") === 'true' ? '%' : 'VND';
            voucherDetails = `Khuyến mãi: Giảm giá ${giamGia.toLocaleLowerCase("vi-VN")} ${loaiGiam}`;
        }

        const ngayLapHoaDon = new Date().toLocaleString("vi-VN");

        const hoten ="Nguyễn Thảo Linh"
        // // Tính tổng tiền thực tế (nếu cần)
        // const tongTienThucTe = tongTien + giaPhuPhi;

        // Nội dung hóa đơn với HTML và CSS
        const invoiceContent = `
        <html>
<head>
    <title>Hóa Đơn Thanh Toán</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1 {
            text-align: center;
            font-size: 28px;
            color: #e65100;  /* Màu cam chủ đạo */
            font-weight: bold;
        }
        .hotel-info {
            text-align: center;
            margin-bottom: 30px;
            background-color: #ffcc80;  /* Màu cam nhạt */
            padding: 20px;
            border-radius: 10px;
        }
        .hotel-info p {
            margin: 5px 0;
            font-size: 16px;
            color: #333;
        }
        .customer-info {
            margin-bottom: 30px;
            font-size: 16px;
        }
        .customer-info p {
            margin: 5px 0;
            color: #555;
        }
        .customer-info strong {
            color: #e65100;
        }
        .payment-details {
            margin-bottom: 20px;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .details-table th, .details-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
        }
        .details-table th {
            background-color: #ff9800;  /* Màu cam đậm cho header */
            color: #fff;
            font-weight: bold;
        }
        .details-table td {
            background-color: #fff;
        }
        .details-table tr:nth-child(even) {
            background-color: #f8f8f8; /* Màu nền xen kẽ */
        }
        .details-table tfoot {
            background-color: #ffcc80;
            font-weight: bold;
        }
        .details-table tfoot th {
            color: #fff;
            background-color: #e65100;  /* Màu cam đậm */
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            font-size: 14px;
            color: #777;
        }
        .footer p {
            margin: 5px 0;
        }
        .button {
            background-color: #e65100; /* Màu cam cho nút */
            color: white;
            padding: 10px 20px;
            text-align: center;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
            display: inline-block;
            margin-top: 20px;
        }
        .button:hover {
            background-color: #ff5722; /* Màu cam sáng khi hover */
        }
    </style>
</head>
<body>
    <h1>HÓA ĐƠN THANH TOÁN</h1>
    <div class="hotel-info">
        <p><strong>DragonBail Hotel</strong></p>
        <p>Địa chỉ: P. Kiều Mai, Phúc Diễn, Từ Liêm, Hà Nội</p>
        <p>Điện thoại: 0397156204</p>
        <p>Email: contact@dragonballhotel.com</p>
    </div>
    <div class="customer-info">
        <p><strong>Thông tin khách hàng:</strong></p>
        <p>Họ và tên: ${hoVaTen}</p>
        <p>Số điện thoại: ${soDienThoai}</p>
        <p>Ngày lập hóa đơn: ${ngayLapHoaDon}</p>
        <p>Nhân viên Thanh Toán: ${hoten}</p>
    </div>
    <table class="details-table">
        <thead>
            <tr>
                <th>Dịch vụ</th>
                <th>Chi tiết</th>
                <th>Thành tiền (VND)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Phòng</td>
                <td>${tenPhong}</td>
                <td>${giaPhong.toLocaleString("vi-VN")}/Ngày</td>
            </tr>
            <tr>
                <td>Tiền cọc</td>
                <td>-</td>
                <td>${tienCoc.toLocaleString("vi-VN")}</td>
            </tr>
            <tr>
                <td>Tổng Tiền Phòng</td>
                <td>-</td>
                <td>${tongTien.toLocaleString("vi-VN")}</td>
            </tr>
            <tr>
                <td>Tiền Phụ Phí</td>
                <td>-</td>
                <td>${giaPhuPhi.toLocaleString("vi-VN")}</td>
            </tr>

             <!-- Thêm thông tin khuyến mãi nếu có -->
                    <tr>
                        <td>Khuyến mãi</td>
                        <td colspan="2">${voucherDetails}</td>
                    </tr>
        </tbody>
        <tfoot>
            <tr>
                <th class="btn btn-warning" colspan="2" >Tổng hóa đơn thanh toán:</th>
                <td>${tienConLai.toLocaleString("vi-VN")}</td>
            </tr>
        </tfoot>
    </table>
    <div class="footer">
        <p>Cảm ơn quý khách đã sử dụng dịch vụ của chúng tôi!</p>
        <p>Khách sạn DragonBail Hotel hân hạnh phục vụ quý khách.</p>
    </div>
</body>
</html>`;

        // Tạo cửa sổ in và hiển thị hóa đơn
        const printWindow = window.open('', '', 'height=800,width=600');
        printWindow.document.write(invoiceContent);
        printWindow.document.close();

        // In hóa đơn và tự động đóng cửa sổ
        printWindow.print();
        printWindow.close();
    }


    var isVoucherApplied = false; // Biến theo dõi voucher đã được chọn hay chưa
    var isPhuPhiApplied = false; // Biến theo dõi phụ phí đã được áp dụng hay chưa

    function tinhTongTien() {
        // Lấy giá trị từ form
        var tienPhuPhi = parseFloat(document.getElementById('tienPhuPhi').value) || 0; // Phụ phí
        var tienConLai = parseFloat(document.getElementById('tienConLai').value) || 0; // Số tiền còn lại

        if (tienConLai <= 0) {
            console.error("Số tiền gốc (tổng tiền còn lại) không hợp lệ!");
            return;
        }

        var voucherSelect = document.getElementById('voucherId');
        var selectedOption = voucherSelect.options[voucherSelect.selectedIndex];

        var giamGia = 0; // Biến lưu giá trị giảm giá

        // Kiểm tra nếu có voucher được chọn và chưa áp dụng voucher trước đó
        if (selectedOption && selectedOption.value) {
            // Hủy voucher cũ nếu đã áp dụng
            if (isVoucherApplied) {
                isVoucherApplied = false; // Hủy áp dụng voucher cũ
            }

            // Kiểm tra voucher mới và tính giảm giá
            var mucGiam = parseFloat(selectedOption.getAttribute('data-muc-giam')) || 0;
            var loaiGiam = selectedOption.getAttribute('data-loai-giam') === "true"; // Phần trăm hay số tiền

            // Giảm tối thiểu và tối đa
            var giamToiThieu = parseFloat(selectedOption.getAttribute('data-giam-toi-thieu')) || 0;
            var giamToiDa = parseFloat(selectedOption.getAttribute('data-giam-toi-da')) || Number.MAX_VALUE;

            if (loaiGiam) {
                giamGia = (mucGiam / 100) * tienConLai; // Giảm giá theo phần trăm
            } else {
                giamGia = mucGiam; // Giảm giá theo số tiền
            }

            // Kiểm tra giảm giá trong khoảng tối thiểu và tối đa
            if (giamGia < giamToiThieu) {
                giamGia = giamToiThieu; // Áp dụng giảm giá tối thiểu
            }
            if (giamGia > giamToiDa) {
                giamGia = giamToiDa; // Áp dụng giảm giá tối đa
            }

            isVoucherApplied = true;  // Đánh dấu voucher đã được áp dụng
        }

        // Nếu không có voucher và phụ phí chưa được áp dụng, phụ phí có thể được cộng vào
        if (!isVoucherApplied && !isPhuPhiApplied) {
            isPhuPhiApplied = true; // Đánh dấu phụ phí đã được áp dụng
        }

        // Tính tiền sau giảm giá
        var tongTienSauGiam = Math.max(0, tienConLai - giamGia); // Tính tiền sau giảm giá

        // Tính tổng tiền thanh toán
        var tongTienThanhToan = tongTienSauGiam + (isPhuPhiApplied ? tienPhuPhi : 0);

        // Cập nhật lại tổng tiền còn lại
        document.getElementById("tienConLai").value = tongTienThanhToan.toFixed(0); // Hiển thị tiền còn lại trong form

        // Cập nhật trạng thái các trường nhập liệu
        if (isVoucherApplied) {
            document.getElementById('tienPhuPhi').disabled = true; // Vô hiệu hóa trường nhập phụ phí khi voucher được chọn
        } else {
            document.getElementById('tienPhuPhi').disabled = false; // Nếu không có voucher, trường phụ phí vẫn có thể nhập
        }

        // Disable trường voucher nếu voucher đã được chọn
        if (isVoucherApplied) {
            document.getElementById('voucherId').disabled = true; // Vô hiệu hóa trường chọn voucher khi đã chọn
        } else {
            document.getElementById('voucherId').disabled = false; // Nếu chưa chọn voucher, trường voucher vẫn có thể chọn
        }
    }




    // document.getElementById('confirmButton').addEventListener('click', function () {
    //     const printInvoice = document.getElementById('printInvoice').checked;
    //
    //     if (printInvoice) {
    //
    //     } else {
    //         console.log("Người dùng không chọn in hóa đơn.");
    //     }
    // });


    // function generateQR(showQR) {
    //     var qrCodeDiv = document.getElementById("qrCode");
    //     var qrCodeContainer = document.getElementById("qrcode-container");
    //     if (showQR) {
    //         qrCodeDiv.style.display = "block";
    //         qrCodeContainer.innerHTML = ""; // Clear QR code if exists
    //
    //         var tongSoTien = document.getElementById("soTien").value;
    //         var qrCodeText = `MB Bank|SoTaiKhoan=0123456789|TenNguoiNhan=NguyenVanA|SoTien=${tongSoTien}|NoiDung=ThanhToan`;
    //
    //         var qrcode = new QRCode(qrCodeContainer, {
    //             text: qrCodeText,
    //             width: 128,
    //             height: 128
    //         });
    //     } else {
    //         qrCodeDiv.style.display = "none";
    //     }
    // }

    document.getElementById("paymentForm").addEventListener("submit", function (e) {
        confirmPayment(e);
    });

    function confirmPayment(e) {
        e.preventDefault();

        // Hiển thị hộp thoại xác nhận bằng SweetAlert
        swal({
            title: "Xác nhận thanh toán",
            text: "Bạn chắc chắn muốn thanh toán chứ?",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        }).then((willPay) => {
            if (willPay) {
                // Nếu người dùng chọn "OK", gửi biểu mẫu
                document.getElementById("paymentForm").submit();
            } else {
                // Nếu người dùng chọn "Cancel", không làm gì
                swal("Thanh toán đã bị hủy!", {
                    icon: "error",
                });
            }
        });
    }


    document.addEventListener("DOMContentLoaded", function () {
        const khuyenMaiSelect = document.getElementById('khuyenMaiSelect');
        console.log("DOM fully loaded and parsed.");

        if (!khuyenMaiSelect) {
            console.error("Element with ID 'khuyenMaiSelect' not found!");
            return;
        }

        console.log("Fetching active khuyen mai...");
        fetch('/api/km/active')
            .then(response => {
                console.log("Response status: ", response.status);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Fetched data: ", data);
                khuyenMaiSelect.innerHTML = '<option value="">--Chọn mã khuyến mãi--</option>';

                if (Array.isArray(data) && data.length > 0) {
                    console.log("Data is an array with items. Processing...");
                    data.forEach(khuyenMai => {
                        const option = document.createElement('option');
                        option.value = khuyenMai.idKhuyenMai;
                        option.textContent = `${khuyenMai.maKhuyenMai} - ${khuyenMai.tenKhuyenMai}`;
                        khuyenMaiSelect.appendChild(option);
                    });
                    console.log("Options added successfully.");
                } else {
                    console.error("Dữ liệu không hợp lệ, không phải là mảng hoặc mảng rỗng.");
                }
            })
            .catch(error => {
                console.error('Error occurred while fetching data:', error);
            });
    });




    function displayQRCode(accountNumber, amount, note, bankName) {
        // Định dạng thông tin cho mã QR
        const qrCodeData = `${bankName}|${accountNumber}|${amount}|${note}`;

        // Tạo URL mã QR
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrCodeData)}&size=200x200`;

        // Lấy phần tử hiển thị mã QR
        const qrCodeElement = document.getElementById("qrCodeDisplay");

        // Hiển thị mã QR lên giao diện
        qrCodeElement.innerHTML = `<img src="${qrCodeUrl}" alt="QR Code" class="img-fluid">`;
    }


    function searchThanhToan() {
        const searchQuery = document.getElementById('search').value.trim(); // Lấy giá trị từ ô tìm kiếm
        const ngayThanhToan = document.getElementById('ngayThanhToan').value; // Lấy giá trị từ ô ngày thanh toán

        // Kiểm tra nếu cả hai trường đều trống thì không thực hiện tìm kiếm
        if (searchQuery === '' && ngayThanhToan === '') {
            console.log('Cả trường tìm kiếm và ngày thanh toán đều trống.');
            return;
        }

        console.log('Search query:', searchQuery); // Log giá trị tìm kiếm để debug
        console.log('Ngày thanh toán:', ngayThanhToan); // Log ngày thanh toán để debug

        // Gửi yêu cầu GET tới API, bao gồm cả ngày thanh toán nếu có
        fetch('/api/km/search?query=' + encodeURIComponent(searchQuery) + '&ngayThanhToan=' + encodeURIComponent(ngayThanhToan), {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.length === 0) {
                    console.log('Không tìm thấy kết quả.');
                    // Hiển thị thông báo không tìm thấy kết quả
                } else {
                    updateTableBody(data); // Gọi hàm cập nhật bảng dữ liệu với dữ liệu trả về từ server
                }
            })
            .catch(error => {
                console.error('Lỗi khi tìm kiếm:', error);
            });
    }


    function updateTableBody(data) {
        var tableBody = document.getElementById('transactionTableBody');
        tableBody.innerHTML = ''; // Xóa dữ liệu cũ trước khi cập nhật

        data.forEach(function (thanhToan) {
            var row = '<tr>' +
                '<td>' + (thanhToan.tenPhong || 'N/A') + '</td>' + // Tên phòng
                '<td>' + (thanhToan.hoVaTen || 'N/A') + '</td>' + // Tên khách hàng
                '<td>' + (thanhToan.tongTien || '0.00') + '</td>' + // Tổng tiền
                '<td>' + (thanhToan.tinhTrang ? 'Đã Thanh Toán' : 'Chưa Thanh Toán') + '</td>' + // Tình trạng thanh toán
                '<td>' + (thanhToan.hoTen || 'N/A') + '</td>' + // Tên nhân viên
                '<td>' + (thanhToan.ngayThanhToan ? new Date(thanhToan.ngayThanhToan).toLocaleDateString() : 'N/A') + '</td>' + // Ngày thanh toán
                '</tr>';

            tableBody.innerHTML += row; // Thêm hàng mới vào bảng
        });
    }


    function searchChekin() {
        var keyword = document.getElementById('keyword').value.trim().toLowerCase(); // Loại bỏ khoảng trắng thừa

        var rows = document.querySelectorAll('#dataTable-1 tbody tr');

        var hasResults = false; // Biến để kiểm tra có kết quả hay không

        rows.forEach(function (row) {
            var hoVaTen = row.cells[3].innerText.toLowerCase();
            var maThanhToan = row.cells[0].innerText.toLowerCase();
            var ngayThanhToan = row.cells[1].innerText.toLowerCase();
            // Kiểm tra xem từ khóa có trong mã đặt phòng hoặc tên khách hàng không
            if (maThanhToan.includes(keyword) || hoVaTen.includes(keyword) || ngayThanhToan.includes(keyword)) {
                row.style.display = ''; // Hiện hàng
                hasResults = true; // Có kết quả
            } else {
                row.style.display = 'none'; // Ẩn hàng
            }
        });

        // Ẩn toàn bộ bảng nếu không có kết quả
        var tableCardBody = document.getElementById('tableCardBody');
        if (hasResults) {
            tableCardBody.style.display = ''; // Hiện bảng
        } else {
            tableCardBody.style.display = 'none'; // Ẩn bảng nếu không có kết quả
        }
    }


</script>


</body>
<script th:include="fragment/script :: script"></script>

</html>